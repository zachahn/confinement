#!/usr/bin/env ruby
# frozen_string_literal: true

if File.exist?(File.expand_path("../.git", __dir__))
  lib = File.expand_path("../lib", __dir__)
  $LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)
end

require "optparse"
require "pathname"

require "confinement/version"

module Confinement
  class CLI
    def self.subcommands
      @subcommands ||= {
        "init" => Init.new,
      }
    end

    def self.script_name
      @script_name ||= File.basename(__FILE__)
    end

    def optparser
      @optparser ||= OptionParser.new do |opts|
        opts.banner = "Usage: #{CLI.script_name} [options] [subcommand [options]]"

        opts.on("--version", "Print version (#{Confinement::VERSION})") do
          puts Confinement::VERSION
          exit
        end

        opts.on("-h", "--help", "Prints this help message") do
        end
      end
    end

    def call(argv)
      optparser.order!(argv)
      subcommand_name = argv.shift

      if subcommand_name.nil?
        puts(optparser)
        exit
      end

      if !self.class.subcommands.key?(subcommand_name)
        $stderr.puts("#{CLI.script_name}: `#{subcommand_name}` is not valid command")
        $stderr.puts
        $stderr.puts(optparser)
        exit(1)
      end

      subcommand = self.class.subcommands.fetch(subcommand_name)
      subcommand.optparser.parse!(argv)
      subcommand.call(argv)
    end

    private

    class Init
      def optparser
        @options ||= {}
        @optparser ||= OptionParser.new do |opts|
          opts.banner = "Usage: #{CLI.script_name} init [directory]"

          opts.on("--force", "Write files without prompting") do
            @force = true
          end

          opts.on("--skip", "Skip files without prompting") do
            @skip = true
          end

          opts.on("-h", "--help", "Prints this help message") do
            puts opts
            exit
          end
        end
      end

      def call(argv)
        if argv.size != 1
          puts optparser
          exit
        end

        require "open3"

        root = Pathname.new(argv.first).expand_path

        templates = data.split(/^==> /)[1..-1]
        templates = templates.filter_map do |template|
          path, *body = template.lines
          body = body.join("")

          [Pathname.new(File.join(root, path.strip)), body.strip + "\n"]
        end

        templates
          .map { |path, _| path.dirname }
          .uniq
          .each { |path| mkdir(path, root) }

        templates.each do |path, body|
          write(path, body, root)
        end

        Dir.chdir(root) do
          run(["yarn", "add", "--dev", "parcel@nightly"])
        end
      end

      private

      def run(command)
        status("exec", command.join(" "))
        Open3.capture2(*command)
      end

      def write(path, body, root)
        relpath = path.relative_path_from(root.dirname)

        if path.exist?
          if @skip
            status("skip", relpath)
          elsif @force
            status("force", relpath)
            path.write(body)
          elsif yes?("overwrite #{path}?")
            status("overwrite", relpath)
            path.write(body)
          else
            status("skip", relpath)
          end
        else
          status("write", relpath)
          path.write(body)
        end
      end

      def mkdir(dir, root)
        if dir.exist?
          status("exist", dir.relative_path_from(root.dirname))
        else
          status("mkdir", dir.relative_path_from(root.dirname))
          dir.mkdir
        end
      end

      def status(action, object)
        space = 12 - action.size
        puts "    #{action}#{" " * space}#{object}"
      end

      def yes?(question)
        print "#{question} (y/N) "
        answer = $stdin.gets

        return false if answer.nil?

        /^y/i.match?(answer)
      end

      def data
        contents = File.read(__FILE__)
        contents.split(/^__END__$/)[1]
      end
    end
  end
end

Confinement::CLI.new.call(ARGV.dup)

__END__
==> config/boot.rb
require "confinement"

==> config/site.rb
require_relative "boot"

Confinement.site = Confinement::Site.build do |site|
  site.root = File.dirname(__dir__)
  site.assets = "assets"
  site.contents = "contents"
  site.layouts = "layouts"
  site.output_root = "public"
end

==> build.rb
require_relative "config/site"

Confinement.site.build do |assets:, layouts:, contents:, routes:|
  assets.init("application.js", entrypoint: true)
  assets.init("application.css", entrypoint: false)

  layouts.init("default.html.erb")

  routes["/"] = contents.init("index.html.erb") do |content|
    content.layout = layouts["default.html.erb"]
  end
end

==> write.rb
require_relative "build"

Confinement::Publish.new(Confinement.site).write

==> package.json
{
  "name": "website",
  "version": "1.0.0",
  "license": "UNLICENSED",
  "devDependencies": {
  },
  "dependencies": {
  }
}

==> assets/application.js
import "./application.css";

==> assets/application.css
body { color: blue }

==> layouts/default.html.erb
<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="<%= assets["application.css"].url_path %>" charset="utf-8">
  </head>
  <body>
    <%= yield %>
  </body>
</html>

==> contents/index.html.erb
hello!
